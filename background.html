<html>
<head>
<script>
  var api = 'http://api.tuenti.com/api';
  var baseurl = 'http://www.tuenti.com/';
  var sid = false;
  var timecheck = 2.5*1000;
  var t;
  var state = false;
  chrome.browserAction.setBadgeBackgroundColor({color:[130, 178, 75,255]});
   
  function setActive (active) {
  	if (active!=state) chrome.browserAction.setIcon({path:"images/"+(active===true?"":"de")+"activated.png"});
  	state = active;
  }
  function loadSession() {
  	chrome.cookies.get({url:api,name:'sid'},  function(cookie) {
  		if (!cookie) {sid=false;setActive(false);return;};
  		sid = cookie.value;
  		checkNotifies();
  	});
  }
  chrome.cookies.onChanged.addListener(function(changeInfo) {
  	var cookie = changeInfo.cookie;
  	if (cookie.name == 'sid' && cookie.domain.indexOf('tuenti.com') > -1) {
  		loadSession();
  	}
  });
  
  function checkNotifies () {
	  if (!sid) {
	  	  return;
	  }
	  var http = new XMLHttpRequest();
	  var params = '{"session_id":"'+sid+'","version":"0.6","requests":[["getUserNotifications",{"max_notifications":8,"types":["unread_friend_messages","unread_spam_messages","new_profile_wall_posts","new_friend_requests","accepted_friend_requests","new_photo_wall_posts","new_tagged_photos","new_event_invitations","new_group_page_invitations","group_admin_promotions","group_member_promotions"]}],["getUserNotifications",{"max_notifications":20,"types":["new_profile_wall_comments"]}]]}';
	  http.open("POST", api, true);
	  
	  //Send the proper header information along with the request
	  http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	  http.setRequestHeader("Content-length", params.length);
	  http.setRequestHeader("Connection", "close");
	  
	  http.onreadystatechange = function() {//Call a function when the state changes.
		  	if(http.readyState == 4 && http.status == 200) {
		  		//notifications = http.responseText;
		  		
		  		eval("var response="+http.responseText+";");
		  		
		  		if (response.error) {
		  			setActive(false);
		  			sid = false;
		  			return;
		  		}
		  		var count = 0;
		  		for (n in response) {
		  			part = response[n];
		  		 	for (b in part) {
		  		 		func = part[b];
		  		 		count += func.count;
		  		 	}
		  		}
		  		text = "";
		  		if (count>0) text=""+count;
		  	    chrome.browserAction.setBadgeText({text:text});
		  		setActive(true);
		  		
		  	}
		  	else {
		  		setActive(false);
		  	}
	  }
	  http.send(params);
	  t=setTimeout("checkNotifies()",timecheck);
	  
  }
  function onClick() {
  	chrome.tabs.create({url:baseurl}, function (tab) {});
  }
  loadSession();
  chrome.browserAction.onClicked.addListener(onClick);
</script>
</head>
</html>
